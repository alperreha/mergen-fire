#!/usr/bin/env bash
set -euo pipefail

VM_ID="${1:?vm id is required}"
VM_DIR="/etc/mergen/vm.d/${VM_ID}"

if [[ -f "${VM_DIR}/env" ]]; then
  # shellcheck disable=SC1090
  source "${VM_DIR}/env"
fi

RUN_DIR="${MGN_RUN_DIR:-/run/mergen/${VM_ID}}"
SOCKET_PATH="${MGN_SOCKET_PATH:-${RUN_DIR}/mergen.socket}"
VM_JSON="${MGN_VM_JSON:-${VM_DIR}/vm.json}"
TIMEOUT_SECONDS="${MGN_CONFIGURE_TIMEOUT_SECONDS:-20}"

if [[ ! -f "${VM_JSON}" ]]; then
  echo "vm.json not found for ${VM_ID}" >&2
  exit 1
fi

if ! command -v curl >/dev/null 2>&1; then
  echo "curl is required for firecracker api calls" >&2
  exit 1
fi
if ! command -v jq >/dev/null 2>&1; then
  echo "jq is required to parse vm.json" >&2
  exit 1
fi

api_call() {
  local method="${1}"
  local path="${2}"
  local payload="${3}"
  local out_file
  local status

  out_file="$(mktemp)"
  status="$(curl -sS \
    --unix-socket "${SOCKET_PATH}" \
    -o "${out_file}" \
    -w "%{http_code}" \
    -X "${method}" \
    "http://localhost${path}" \
    -H 'accept: application/json' \
    -H 'content-type: application/json' \
    -d "${payload}")"

  if [[ "${status}" -lt 200 || "${status}" -ge 300 ]]; then
    echo "firecracker api call failed: ${method} ${path} status=${status}" >&2
    cat "${out_file}" >&2 || true
    rm -f "${out_file}"
    exit 1
  fi
  rm -f "${out_file}"
}

derive_host_ip_from_guest() {
  local guest_ip="${1:-}"
  if [[ "${guest_ip}" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
    IFS='.' read -r o1 o2 o3 o4 <<<"${guest_ip}"
    local last=1
    if [[ "${o4}" == "1" ]]; then
      last=2
    fi
    echo "${o1}.${o2}.${o3}.${last}"
    return 0
  fi
  return 1
}

augment_boot_source_ip_arg() {
  local boot_source_json="${1}"
  local guest_ip="${MGN_GUEST_IP:-}"
  if [[ -z "${guest_ip}" ]]; then
    echo "${boot_source_json}"
    return 0
  fi

  local boot_args
  boot_args="$(echo "${boot_source_json}" | jq -r '.boot_args // ""')"
  if echo "${boot_args}" | tr ' ' '\n' | grep -Eq '^ip='; then
    echo "${boot_source_json}"
    return 0
  fi

  local host_ip="${MGN_HOST_IP:-}"
  if [[ -z "${host_ip}" ]]; then
    host_ip="$(derive_host_ip_from_guest "${guest_ip}" || true)"
  fi
  if [[ -z "${host_ip}" ]]; then
    echo "${boot_source_json}"
    return 0
  fi

  local guest_mask="${MGN_GUEST_NETMASK:-255.255.255.0}"
  local guest_iface="${MGN_GUEST_IFACE:-eth0}"
  local kernel_ip_arg="ip=${guest_ip}::${host_ip}:${guest_mask}::${guest_iface}:off"

  if [[ -n "${boot_args}" ]]; then
    boot_args="${boot_args} ${kernel_ip_arg}"
  else
    boot_args="${kernel_ip_arg}"
  fi
  boot_args="$(echo "${boot_args}" | awk '{$1=$1; print}')"

  echo "${boot_source_json}" | jq -c --arg boot_args "${boot_args}" '.boot_args = $boot_args'
}

deadline=$((SECONDS + TIMEOUT_SECONDS))
while [[ ! -S "${SOCKET_PATH}" ]]; do
  if [[ ${SECONDS} -ge ${deadline} ]]; then
    echo "mergen socket not available for configure start: ${VM_ID}" >&2
    exit 1
  fi
  sleep 0.2
done

MACHINE_CONFIG="$(jq -c '.["machine-config"] // empty' "${VM_JSON}")"
BOOT_SOURCE="$(jq -c '.["boot-source"] // empty' "${VM_JSON}")"
if [[ -z "${MACHINE_CONFIG}" || "${MACHINE_CONFIG}" == "null" ]]; then
  echo "machine-config missing in ${VM_JSON}" >&2
  exit 1
fi
if [[ -z "${BOOT_SOURCE}" || "${BOOT_SOURCE}" == "null" ]]; then
  echo "boot-source missing in ${VM_JSON}" >&2
  exit 1
fi
BOOT_SOURCE="$(augment_boot_source_ip_arg "${BOOT_SOURCE}")"

api_call PUT "/machine-config" "${MACHINE_CONFIG}"
api_call PUT "/boot-source" "${BOOT_SOURCE}"

while IFS= read -r drive; do
  DRIVE_ID="$(echo "${drive}" | jq -r '.drive_id // empty')"
  if [[ -z "${DRIVE_ID}" ]]; then
    echo "drive entry missing drive_id in ${VM_JSON}" >&2
    exit 1
  fi
  api_call PUT "/drives/${DRIVE_ID}" "${drive}"
done < <(jq -c '.drives[]?' "${VM_JSON}")

while IFS= read -r iface; do
  IFACE_ID="$(echo "${iface}" | jq -r '.iface_id // empty')"
  if [[ -z "${IFACE_ID}" ]]; then
    echo "network interface entry missing iface_id in ${VM_JSON}" >&2
    exit 1
  fi
  api_call PUT "/network-interfaces/${IFACE_ID}" "${iface}"
done < <(jq -c '.["network-interfaces"][]?' "${VM_JSON}")

VSOCK_CONFIG="$(jq -c '.vsock // empty' "${VM_JSON}")"
if [[ -n "${VSOCK_CONFIG}" && "${VSOCK_CONFIG}" != "null" ]]; then
  api_call PUT "/vsock" "${VSOCK_CONFIG}"
fi

api_call PUT "/actions" '{"action_type":"InstanceStart"}'
echo "firecracker configured and started for vm=${VM_ID}" >&2
exit 0
