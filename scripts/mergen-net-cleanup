#!/usr/bin/env bash
set -euo pipefail

VM_ID="${1:?vm id is required}"
VM_DIR="/etc/mergen/vm.d/${VM_ID}"

if [[ -f "${VM_DIR}/env" ]]; then
  # shellcheck disable=SC1090
  source "${VM_DIR}/env"
fi

# Cleanup named netns created by mergen-net-setup.
if command -v ip >/dev/null 2>&1; then
  NETNS_NAME="${MGN_NETNS:-mergen-${VM_ID:0:8}}"
  if ip netns list | awk '{print $1}' | grep -Fxq "${NETNS_NAME}"; then
    ip netns delete "${NETNS_NAME}" || true
  fi
fi

exit 0
