#!/usr/bin/env bash
set -euo pipefail

VM_ID="${1:?vm id is required}"
VM_DIR="/etc/mergen/vm.d/${VM_ID}"

# Minimal deterministic placeholder:
# - Read env file if present
# - Validate required metadata files exist
# Real implementation should create netns/tap and DNAT rules.
if [[ -f "${VM_DIR}/env" ]]; then
  # shellcheck disable=SC1090
  source "${VM_DIR}/env"
fi

if [[ ! -f "${VM_DIR}/meta.json" ]]; then
  echo "meta.json not found for ${VM_ID}" >&2
  exit 1
fi

# Create named netns for forwarder setns dial path (/run/netns/<name>).
if ! command -v ip >/dev/null 2>&1; then
  echo "ip command not found in PATH" >&2
  exit 1
fi

NETNS_NAME="${MGN_NETNS:-mergen-${VM_ID:0:8}}"
if ! ip netns list | awk '{print $1}' | grep -Fxq "${NETNS_NAME}"; then
  ip netns add "${NETNS_NAME}"
fi

exit 0
